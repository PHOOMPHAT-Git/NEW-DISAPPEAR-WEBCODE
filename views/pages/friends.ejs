<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Disappear</title>
    <link rel="stylesheet" href="/css/pages/friends.css">
    <link rel="stylesheet" href="/css/components/scrollbar.css">
    <link rel="stylesheet" href="/css/alert.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
</head>
<body>
    <main class="container">
        <a href="/account" class="btn-back">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Go Back
        </a>

        <section class="section">
            <h2 class="section-title">Friends</h2>
            <p class="section-subtitle">Manage your friends and friend requests</p>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('friends')">
                    Friends ( <span id="friendsCount">0</span> )
                </button>
                <button class="tab-btn" onclick="switchTab('requests')">
                    Requests ( <span id="requestsCount">0</span> )
                </button>
            </div>

            <div id="friendsTab" class="tab-content active">
                <div id="friendsList"></div>
            </div>

            <div id="requestsTab" class="tab-content">
                <div id="requestsList"></div>
            </div>
        </section>
    </main>

    <script src="/js/alert.js"></script>
    <script>
        let currentTab = 'friends';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        async function loadFriends() {
            try {
                const response = await fetch('/friends/list');
                const data = await response.json();

                if (data.success) {
                    const friendsList = document.getElementById('friendsList');
                    document.getElementById('friendsCount').textContent = data.friends.length;

                    if (data.friends.length === 0) {
                        friendsList.innerHTML = `
                            <div class="empty-state">
                                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <p>No friends yet. Start adding friends from your account page!</p>
                            </div>
                        `;
                        return;
                    }

                    friendsList.innerHTML = data.friends.map(friend => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-name">${escapeHtml(friend.username)}</div>
                                <div class="friend-meta">Member since ${new Date(friend.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn-small btn-remove" onclick="removeFriend('${escapeHtml(friend.username)}')">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading friends:', error);
                toast.error('Failed to load friends');
            }
        }

        async function loadRequests() {
            try {
                const response = await fetch('/friends/requests');
                const data = await response.json();

                if (data.success) {
                    const requestsList = document.getElementById('requestsList');
                    document.getElementById('requestsCount').textContent = data.requests.length;

                    if (data.requests.length === 0) {
                        requestsList.innerHTML = `
                            <div class="empty-state">
                                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <line x1="19" y1="8" x2="19" y2="14"/>
                                    <line x1="22" y1="11" x2="16" y2="11"/>
                                </svg>
                                <p>No pending friend requests</p>
                            </div>
                        `;
                        return;
                    }

                    requestsList.innerHTML = data.requests.map(request => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-name">${escapeHtml(request.from.username)}</div>
                                <div class="friend-meta">Sent ${new Date(request.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn-small btn-accept" onclick="acceptRequest('${escapeHtml(request.from.username)}')">
                                    Accept
                                </button>
                                <button class="btn-small btn-remove" onclick="cancelRequest('${escapeHtml(request.from.username)}')">
                                    Decline
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                toast.error('Failed to load friend requests');
            }
        }

        async function removeFriend(username) {
            if (!confirm(`Remove ${username} from friends?`)) return;

            try {
                const response = await fetch('/friends/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    toast.success(data.message);
                    loadFriends();
                } else {
                    toast.error(data.message || 'Failed to remove friend');
                }
            } catch (error) {
                console.error('Error removing friend:', error);
                toast.error('An error occurred');
            }
        }

        async function acceptRequest(username) {
            try {
                const response = await fetch('/friends/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    toast.success(data.message);
                    loadRequests();
                    loadFriends();
                } else {
                    toast.error(data.message || 'Failed to accept request');
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                toast.error('An error occurred');
            }
        }

        async function cancelRequest(username) {
            try {
                const response = await fetch('/friends/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    toast.success(data.message);
                    loadRequests();
                } else {
                    toast.error(data.message || 'Failed to cancel request');
                }
            } catch (error) {
                console.error('Error cancelling request:', error);
                toast.error('An error occurred');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadFriends();
        loadRequests();
    </script>
    <script src="/js/security.js"></script>
    <script src="/js/turbo-nav.js"></script>
</body>
</html>
